<link rel="import" href="bower_components/firebase-element/firebase-auth.html">
<dom-module id="admin-login">
  <template>
    <firebase-auth id="firebaseLogin" user="{{user}}" status-known="{{statusKnown}}" location="https://sweltering-fire-3131.firebaseio.com/points" provider="{{provider}}" on-error="errorHandler" on-user-created="userSuccessHandler" on-password-changed="userSuccessHandler" on-password-reset="userSuccessHandler" on-user-removed="userSuccessHandler"></firebase-auth>

    <!-- Provider type: -->
    <select value="{{provider::change}}">
      <option>anonymous</option>
      <option>facebook</option>
      <option>github</option>
      <option>google</option>
      <option>twitter</option>
      <option>password</option>
    </select>
    <!-- Login params (JSON):
    <input value="{{params::input}}" id="params">
    <em>Required by some provider types</em>
    <br> -->

    <div hidden$="{{computePasswordHidden(provider)}}">
      <br><em>password-specific options:</em><br>
      <paper-input id="email" value="{{ email::input }}" label="Email"></paper-input>
      <paper-input type="password" id="password" value="{{ password::input }}" label="Password"></paper-input>
      <!-- <paper-button id="login" raised>Login</paper-button> -->
      <!-- <input placeholder="email" value="{{email::input}}">
      <input type="password" placeholder="password" value="{{password::input}}">
      <button on-tap="createUserHandler" disabled$="{{computeCreateUserDisabled(email, password)}}">Create user</button> -->
      <br>
      <!-- <input placeholder="new password" value="{{newPassword::input}}"> -->
      <!-- <button on-tap="changePasswordHandler" disabled$="{{computeChangePasswordDisabled(email, password, newPassword)}}">Change password</button> -->
      <!-- <br> -->
      <!-- <button on-tap="resetPasswordHandler" disabled$="{{computeResetPasswordDisabled(email, password)}}">Reset password</button> -->
      <!-- <button on-tap="removeUserHandler" disabled$="{{computeRemoveUserDisabled(email, password)}}">Remove user</button> -->
    <!-- </div> -->
    <br>
    <div id="message">[[message]]</div>
    <br>

    <paper-button on-tap="login" hidden$="{{computeLoginHidden(statusKnown, user)}}" raised>Login</paper-button>
    <paper-button on-tap="logout" hidden$="{{computeLogoutHidden(statusKnown, user)}}" raised>Logout</paper-button>

    <!-- <button on-tap="login">Login</button>
    <button on-tap="logout">Logout</button> -->

    <h3>Login status:</h3>
    <p>{{computeLoginStatus(statusKnown, user)}}</p>

    <h3>User ID:</h3>
    <pre>{{user.uid}}</pre>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'admin-login',

    properties: {
      provider: {
        type: String,
        value: 'anonymous'
      },

      message: {
        type: String,
        value: ''
      },

      email: {
        type: String,
        value: ''
      },

      password: {
        type: String,
        value: ''
      },

      user: {
        type: Object,
        value: null
      },

      statusKnown: {
        type: Boolean
      }
    },

    login: function() {
      var params;

      try {
        params = JSON.parse(this.params);
      } catch (e) {
        params = null;
      }

      if (this.provider == 'password') {
        params = params || {};
        params.email = this.email;
        params.password = this.password;
      }
      this.$.firebaseLogin.login(params);
      this.redirectLogin();
    },

    logout: function() {
      this.$.firebaseLogin.logout();
      this.redirectLogout();
    },

    redirectLogin: function() {
      window.location.href = 'http://127.0.0.1:5000/edit#!/edit';
    },

    redirectLogout: function() {
      window.location.href = 'http://127.0.0.1:5000';
    },

    errorHandler: function(e) {
      this.message = 'Error: ' + e.detail.message;
    },

    userSuccessHandler: function(e) {
      this.message = e.type + ' success!';
    },

    createUserHandler: function(e) {
      this.$.firebaseLogin.createUser(this.email, this.password);
    },

    changePasswordHandler: function(e) {
      this.$.firebaseLogin.changePassword(this.email, this.password, this.newPassword);
    },

    resetPasswordHandler: function(e) {
      this.$.firebaseLogin.sendPasswordResetEmail(this.email);
    },

    removeUserHandler: function(e) {
      this.$.firebaseLogin.removeUser(this.email, this.password);
    },

    computePasswordHidden: function(provider) {
      return provider !== 'password';
    },

    computeCreateUserDisabled: function(email, password) {
      return !email || !password;
    },

    computeChangePasswordDisabled: function(email, password, newPassword) {
      return !email || !password || !newPassword;
    },

    computeResetPasswordDisabled: function(email, password) {
      return !email || !password;
    },

    computeRemoveUserDisabled: function(email, password) {
      return !email || !password;
    },

    computeLoginHidden: function(statusKnown, user) {
      return !statusKnown || !!user;
    },

    computeLogoutHidden: function(statusKnown, user) {
      return !statusKnown || !user;
    },

    computeLoginStatus: function(statusKnown, user) {
      if (statusKnown && user) {
        return 'Logged in';
      }

      if (statusKnown) {
        return 'Logged out';
      }

      return 'Unknown (checking status...)';
    }
  });
</script>
